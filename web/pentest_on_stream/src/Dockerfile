FROM bandi13/gui-docker:latest
USER root
RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-get update -y && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:obsproject/obs-studio && \
    apt-get update -y && \
    apt-get install -y ffmpeg obs-studio python3-pip supervisor && \
    apt-get clean -y

COPY supervisord.conf /etc/supervisor/supervisord.conf
COPY start_obs.sh /opt/startup_scripts/

USER dockerUser
WORKDIR /app
ENV PATH="/home/dockerUser/.local/bin:$PATH"

COPY Pipfile Pipfile.lock /app/
RUN pip install --user pipenv && pipenv install --deploy --ignore-pipfile

COPY --chown=dockerUser:dockerUser /app/ /app/
COPY --chown=dockerUser:dockerUser obs-studio/ /home/dockerUser/.config/obs-studio/
COPY --chown=dockerUser:dockerUser config.toml /home/dockerUser/

EXPOSE 8080
ENTRYPOINT [""]
CMD ["supervisord"]