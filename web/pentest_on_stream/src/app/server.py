#!/usr/bin/env python3
from flask import Flask, request, send_file, redirect, url_for, make_response, send_from_directory
import obsws_python as obs
from redis import Redis
from rq import Queue
from time import sleep
import base64
import io

#sleep(30)

cl = obs.ReqClient()
cl.set_current_program_scene("chat")
cl.press_input_properties_button("Browser", "refreshnocache")

# q = Queue(connection=Redis())

app = Flask(__name__)

@app.route("/")
def index():
    return "index"

@app.route("/chat")
def chat():
    resp = make_response(send_file("chat.html"))
    return resp

@app.route("/visit")
def visit():
    cl.press_input_properties_button("Browser", "refreshnocache")
    sleep(1)
    # cl.trigger_hot_key_by_name("OBSBasic.Screenshot")
    screenshot_b64 = cl.get_source_screenshot(name="chat", img_format="jpg", width=1280, height=720, quality=90)
    screenshot_data = io.BytesIO()
    screenshot_data.write(base64.b64decode(screenshot_b64.image_data.split(",")[1]))
    screenshot_data.seek(0)
    return send_file(screenshot_data, mimetype="image/jpg")


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080, debug=True)