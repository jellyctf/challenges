FROM bandi13/gui-docker:latest
USER root
RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-get update -y && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:obsproject/obs-studio && \
    apt-get update -y && \
    apt-get install -y ffmpeg obs-studio python3-pip supervisor && \
    apt-get clean -y

ADD https://d307a34p6mmcbn.cloudfront.net/releases/valkey-7.2.5-focal-x86_64.tar.gz /tmp/valkey.tar.gz
RUN tar -C /usr/local/ --strip-components=1 -xf /tmp/valkey.tar.gz && rm /tmp/valkey.tar.gz
COPY supervisord.conf /etc/supervisor/supervisord.conf
COPY start_obs.sh /opt/startup_scripts/

USER dockerUser
WORKDIR /app
ENV PATH="/home/dockerUser/.local/bin:$PATH"

COPY Pipfile Pipfile.lock /app/
RUN pip install --user pipenv && pipenv install --deploy --ignore-pipfile

COPY --chown=dockerUser:dockerUser /app/ /app/
COPY --chown=dockerUser:dockerUser obs-studio/ /home/dockerUser/.config/obs-studio/

EXPOSE 8080
ENTRYPOINT [""]
CMD ["supervisord"]